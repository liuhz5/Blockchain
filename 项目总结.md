# 实验报告

*18342058* 刘泓泽 *18342128* 张心悦

## 项目背景
基于已有的开源区块链系统FISCO-BCOS，以联盟链为主，开发基于区块链或区块链智能合约的供应链金融平台，实现供应链应收账款资产的溯源、流转。   
![1](./images/图片1.png)     

## 项目要求
1. 功能一：实现采购商品—签发应收账款交易上链。例如车企从轮胎公司购买一批轮胎并签订应收账款单据。
2. 功能二：实现应收账款的转让上链，轮胎公司从轮毂公司购买一笔轮毂，便将于车企的应收账款单据部分转让给轮毂公司。轮毂公司可以利用这个新的单据去融资或者要求车企到期时归还钱款。
3. 功能三：利用应收账款向银行融资上链，供应链上所有可以利用应收账款单据向银行申请融资。
4. 功能四：应收账款支付结算上链，应收账款单据到期时核心企业向下游企业支付相应的欠款。

## 项目设计
#### 总体要求：
    根据作业要求，将供应链上的每一笔交易和应收账款单据上链，同时引入第三方可信机构来确认这些信息的交易，例如银行，物流公司等，确保交易和单据的真实性。同时，支持应收账款的转让，融资，清算等，让核心企业的信用可以传递到供应链的下游企业，减小中小企业的融资难度。
#### 方案设计：
   将企业的应收账款单据存储在通过 FISCO BCOS 部署的四节点联盟链上。我们需要解决的是供应链上下游的信息不对等而导致的融资难问题，当两个企业签订了应收账款单据后，将它们的公司信息、应收数目上链，在必要时，企业间的应收账款可以转移到第三方，比如题目例子中轮胎公司可以将宝马公司的 500 万应收账款单据转移给轮毂公司。  
   总交易流程图绘制如下：  
![2](./images/图片2.png)    
#### 数据结构设计：
![image-2020121218310978](./images/image-20201212183109786.png)   
 bill结构体存储了每一笔应收账款单据的详细信息    
![image-20201212183226312](./images/image-20201212183226312.png)     
company结构体存储了每个公司的名称以及地址，并通过映射![image-20201212183620594](./images/image-20201212183620594.png)记录公司的应收账款总额。
该设计的巧妙之处在于公司的结构体内不含有关欠款金额等的信息，可以提高空间的利用率。    
#### 功能实现设计：
智能合约的核心设计如下：  
1. 功能一:实现采购商品—签发应收账款 交易上链。例如车企从轮胎公司购买一批轮胎并签订应收账款单据。      
   ​		<img src="./images/image-20201212190058339.png" alt="image-20201212190058339" style="zoom:67%;" />  

2. 功能二：实现应收账款的转让上链，轮胎公司从轮毂公司购买一笔轮毂，便将于车企的应收账款单据部分转让给轮毂公司。轮毂公司可以利用这个新的单据去融资或者要求车企到期时归还钱款。   
   ​	   <img src="./images/image-20201212190120314.png" alt="image-20201212190120314" style="zoom:67%;" />

3. 功能三：利用应收账款向银行融资上链，供应链上所有可以利用应收账款单据向银行申请融资。    
   ​		<img src="./images/image-20201212190134569.png" alt="image-20201212190134569" style="zoom:67%;" /> 

4. 功能四：应收账款支付结算上链，应收账款单据到期时核心企业向下游企业支付相应的欠款。   
   ​		<img src="./images/image-20201212190155910.png" alt="image-20201212190155910" style="zoom:67%;" />	 



## 功能测试

使用WeBase可视化平台实现功能的测试：

#### 添加用户并部署合约

​		在webase-web 上的私钥管理中添加四个用户:普通企业用户car、steel、hub分别表示汽车企业，轮胎公司，轮毂公司；Bank表示第三方权威机构 。

![image-20201212191143246](./images/image-20201212191143246.png)

​		在合约IDE界面，将编译好的合约部署到用户bank上。

![image-20201212191513881](./images/image-20201212191513881.png)

#### 功能测试：

**验证功能1**：**实现采购商品—签发应收账款交易上链**

​		调用 create_bill 来创建 车企car 欠下轮胎公司steel 2000 资金的应收账款单据(实际应用中，车企和轮胎公司的资金无变化）

​		<img src="./images/image-20201212193655574.png" alt="image-20201212193655574" style="zoom:67%;" /> 

​		显示如下，说明创建成功。

​		<img src="./images/image-20201212193539749.png" alt="image-20201212193539749" style="zoom:67%;" />	 

​		调用辅助函数GetBill()，查看轮胎公司steel的应收账款总额

​		<img src="./images/image-20201212223410078.png" alt="image-20201212223410078" style="zoom:67%;" />  

​		可以看到结果显示为2000，功能一验证成功。

​		<img src="./images/image-20201212223330304.png" alt="image-20201212223330304" style="zoom:67%;" /> 



**验证功能二**:**实现应收账款的转让上链**

​		首先通过功能一，创建轮胎公司欠轮毂公司1000资金的应收账款单据，结果如下：

​		<img src="./images/image-20201212225209433.png" alt="image-20201212225209433" style="zoom:67%;" /> 

​		然后调用 transfer_bill，将轮胎公司欠轮毂公司1000资金的应收账款单据转移到车企上，即功能二实现后车企欠轮胎公司资金1000，同时车企欠轮毂公司资金1000，轮胎公司不再欠轮毂公司资金。

​		<img src="./images/image-20201212230754175.png" alt="image-20201212230754175" style="zoom:67%;" /> 

​		最后，查询轮胎公司和轮毂公司的应收账款单据，结果如下：

​		轮胎公司：

​		<img src="./images/image-20201212230929328.png" alt="image-20201212230929328" style="zoom:67%;" /> 

​		轮毂公司：

​		<img src="./images/image-20201212231011118.png" alt="image-20201212231011118" style="zoom:67%;" />	 

​		此时轮胎公司的应收账款单据已经由2000变为1000，功能二实现。



**验证功能三**: **利用应收账款向银行融资上链**

​		首先调用GetBill函数查看轮毂公司的总应收账款，结果如下：

​		<img src="./images/image-20201212231850197.png" alt="image-20201212231850197" style="zoom:67%;" /> 

​		然后调用函数GetDebt，获取轮毂公司的总应收账款，实现向银行申请融资。

​		<img src="./images/image-20201212231603345.png" alt="image-20201212231603345" style="zoom:67%;" />		 

​		显示如下，证明功能三的融资上链成功。

​		<img src="./images/image-20201212231528499.png" alt="image-20201212231528499" style="zoom:67%;" /> 



**验证功能4：应收账款支付结算上链**

​		通过调用函数PayDebt实现车企向轮胎公司偿还应收账款500资金

​		<img src="./images/image-20201212232249232.png" alt="image-20201212232249232" style="zoom:67%;" /> 

​		结果如下：

​		<img src="./images/image-20201212232340627.png" alt="image-20201212232340627" style="zoom:67%;" /> 

​		然后调用辅助函数GetBill查询轮胎公司的应收账款总额，结果为500，证明车企已向轮胎公司偿还应收账款500资金，功能四验证成功。

​		<img src="./images/image-20201213003649207.png" alt="image-20201213003649207" style="zoom:67%;" />
